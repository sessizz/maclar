@model Maclar.Web.Models.MatchesIndexViewModel

@{
    ViewData["Title"] = "Maç Takvimi";
}

<div class="row mb-3">
    <div class="col-md-6">
        <h2>İstanbul Voleybol Maç Takvimi</h2>
        <p class="text-muted mb-1">
            Kaynak: <a href="https://istanbul.voleyboliltemsilciligi.com/MacTakvimi" target="_blank" rel="noopener">istanbul.voleyboliltemsilciligi.com/MacTakvimi</a>
        </p>
        @if (Model.LastUpdatedAt.HasValue)
        {
            <p class="text-muted mb-0">
                Son güncelleme (UTC): @Model.LastUpdatedAt.Value.ToString("dd.MM.yyyy HH:mm")
            </p>
        }
    </div>
    <div class="col-md-6 text-md-end mt-3 mt-md-0">
        <form asp-action="Index" asp-controller="Matches" method="get" class="d-inline-flex justify-content-end align-items-start gap-2">
            <div class="flex-grow-1">
                <input id="matchSearch"
                       name="search"
                       class="form-control form-control-lg"
                       placeholder="Arama"
                       title="Takım adı, tarih, salon, küme ve kategori alanlarında aynı anda arama yapabilirsiniz. Örnek: 'fener mdk 22.12 beylikdüzü'"
                       value="@Model.Search" />
                <small class="text-muted">Birden fazla kelimeyle (takım, tarih, salon, küme, kategori) aynı anda arama yapabilirsiniz.</small>
            </div>
            <div class="mt-1">
                <button type="submit" formaction="@Url.Action("Refresh", "Matches")" formmethod="post" class="btn btn-sm btn-outline-secondary">
                    Verileri yenile
                </button>
            </div>
            @Html.AntiForgeryToken()
        </form>
    </div>
</div>

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-warning">
        @Model.ErrorMessage
    </div>
}

<div class="table-responsive">
    <table class="table table-striped table-hover align-middle" id="matchesTable">
        <thead class="table-light">
            <tr>
                <th>Tarih</th>
                <th>Saat</th>
                <th>Salon</th>
                <th>Ev Sahibi</th>
                <th>Misafir</th>
                <th>Küme</th>
                <th>Kategori</th>
                <th>Set Sonuçları</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var match in Model.Matches)
        {
            <tr>
                <td>@(match.Date?.ToString("dd.MM.yyyy") ?? match.RawDateText)</td>
                <td>@(match.Time?.ToString(@"hh\:mm") ?? match.RawTimeText)</td>
                <td>@match.Venue</td>
                <td class="team-cell">
                    @match.HomeTeam
                    @if (match.HomeSets.HasValue)
                    {
                        @($" ({match.HomeSets})")
                    }
                </td>
                <td class="team-cell">
                    @match.AwayTeam
                    @if (match.AwaySets.HasValue)
                    {
                        @($" ({match.AwaySets})")
                    }
                </td>
                <td>@match.League</td>
                <td>
                    @match.CategoryCode
                    @if (!string.IsNullOrWhiteSpace(match.CategoryDescription))
                    {
                        <span class="text-muted">(@match.CategoryDescription)</span>
                    }
                </td>
                <td>@match.SetScores</td>
            </tr>
        }
        </tbody>
    </table>
</div>

@section Scripts {
    <script>
        (function () {
            const searchInput = document.getElementById('matchSearch');
            const table = document.getElementById('matchesTable');
            if (!searchInput || !table) {
                return;
            }

            const rows = Array.from(table.querySelectorAll('tbody tr'));

            function normalize(text) {
                return (text || '').toLocaleLowerCase('tr-TR');
            }

            function parseTokens(raw) {
                const tokens = [];
                const regex = /"([^"]+)"|(\S+)/g;
                let match;
                while ((match = regex.exec(raw)) !== null) {
                    const value = match[1] || match[2];
                    if (value) {
                        tokens.push(normalize(value));
                    }
                }
                return tokens;
            }

            function filter() {
                const raw = searchInput.value || '';
                const tokens = parseTokens(raw);

                if (tokens.length === 0) {
                    rows.forEach(r => r.style.display = '');
                    return;
                }

                rows.forEach(row => {
                    // Aramada dikkate alınacak hücreler:
                    // Tarih, Saat, Salon, Ev Sahibi, Misafir, Küme, Kategori
                    const date = row.cells[0]?.textContent || '';
                    const time = row.cells[1]?.textContent || '';
                    const venue = row.cells[2]?.textContent || '';
                    const home = row.cells[3]?.textContent || '';
                    const away = row.cells[4]?.textContent || '';
                    const league = row.cells[5]?.textContent || '';
                    const category = row.cells[6]?.textContent || '';

                    const haystack = normalize(
                        date + ' ' +
                        time + ' ' +
                        venue + ' ' +
                        home + ' ' +
                        away + ' ' +
                        league + ' ' +
                        category
                    );

                    const matchAllTokens = tokens.every(t => haystack.includes(t));

                    if (matchAllTokens) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            searchInput.addEventListener('input', filter);
        })();
    </script>
}


